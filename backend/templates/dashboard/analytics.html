{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics - RRS Admin{% endblock %}

{% block breadcrumb %}
    <span>Analytics</span>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">Reports Analytics</h1>
        <div class="header-actions">
            <span>Last updated: {% now "DATETIME_FORMAT" %}</span>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_reports }}</div>
            <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ reports_today }}</div>
            <div class="stat-label">Today's Reports</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ avg_response_time }}h</div>
            <div class="stat-label">Avg Response Time</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ resolution_rate }}%</div>
            <div class="stat-label">Resolution Rate</div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
            <div class="card-header">
                <h3>Reports by Category</h3>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="250"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Reports by Status</h3>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
            <div class="card-header">
                <h3>Reports Timeline (Last 30 Days)</h3>
            </div>
            <div class="card-body">
                <canvas id="timelineChart" height="250"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Response Time Distribution</h3>
            </div>
            <div class="card-body">
                <canvas id="responseTimeChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Categories Table -->
    <div class="card">
        <div class="card-header">
            <h3>Category Performance</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Total Reports</th>
                        <th>Avg Response Time</th>
                        <th>Resolution Rate</th>
                        <th>Priority Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in category_stats %}
                    <tr>
                        <td>{{ category.name }}</td>
                        <td>{{ category.total }}</td>
                        <td>{{ category.avg_response }} hours</td>
                        <td>{{ category.resolution_rate }}%</td>
                        <td>
                            {% if category.priority == 'High' %}
                            <span class="badge badge-danger">High</span>
                            {% elif category.priority == 'Medium' %}
                            <span class="badge badge-warning">Medium</span>
                            {% else %}
                            <span class="badge badge-success">Low</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Parse JSON data from Django context
    const categoryData = JSON.parse('{{ category_data|safe }}');
    const statusData = JSON.parse('{{ status_distribution|safe }}');
    const timelineData = JSON.parse('{{ timeline_data|safe }}');
    const responseData = JSON.parse('{{ response_distribution|safe }}');
    
    // Color palette
    const colors = {
        primary: '#0088ce',
        success: '#28a745',
        warning: '#ffc107',
        danger: '#dc3545',
        info: '#17a2b8',
        secondary: '#6c757d'
    };
    
    // Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryData),
            datasets: [{
                data: Object.values(categoryData),
                backgroundColor: [
                    '#0088ce', '#00a896', '#e63946', '#ff9e00', '#6a4c93', '#8ac926', '#ff6b6b', '#4ecdc4'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 13 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            label += context.parsed || 0;
                            label += ' reports';
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: [
                    '#0088ce', '#ffc107', '#17a2b8', '#28a745', '#6c757d', '#e63946'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 13 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            label += context.parsed || 0;
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Timeline Chart (Last 30 Days)
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: Object.keys(timelineData),
            datasets: [{
                label: 'Reports Submitted',
                data: Object.values(timelineData),
                borderColor: colors.primary,
                backgroundColor: 'rgba(0, 136, 206, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: colors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: {
                        font: { size: 13 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 10,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0,0,0,0.05)'
                    },
                    title: {
                        display: true,
                        text: 'Number of Reports'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Response Time Distribution Chart
    const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
    new Chart(responseCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(responseData),
            datasets: [{
                label: 'Number of Reports',
                data: Object.values(responseData),
                backgroundColor: [
                    colors.success,
                    colors.info,
                    colors.warning,
                    colors.danger,
                    '#8b0000'
                ],
                borderColor: '#fff',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'x',
            plugins: {
                legend: {
                    labels: {
                        font: { size: 13 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 10,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' reports';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>
{% endblock %}