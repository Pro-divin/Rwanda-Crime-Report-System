{% extends 'base.html' %}
{% load static %}

{% block title %}Map View - RRS Admin{% endblock %}

{% block extra_css %}
<!-- Leaflet Core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Marker Cluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<!-- Leaflet Draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<!-- Fullscreen -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.css" />

<style>
:root {
    --color-primary: #0088ce;
    --color-success: #28a745;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --color-info: #17a2b8;
    --color-muted: #6c757d;
    --color-dark: #343a40;
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --radius-md: 8px;
    --radius-lg: 12px;
}

/* Map Container */
.map-wrapper {
    position: relative;
    background: #1a1a2e;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
}

#map {
    height: 70vh;
    min-height: 500px;
    width: 100%;
    z-index: 1;
}

/* Map Controls Panel */
.map-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.control-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: white;
    border: none;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1.1rem;
}

.control-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: scale(1.05);
}

.control-btn.active {
    background: var(--color-primary);
    color: white;
}

.control-btn[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Layer Switcher */
.layer-switcher {
    position: absolute;
    top: 10px;
    left: 60px;
    z-index: 1000;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.layer-btn {
    display: block;
    padding: 10px 16px;
    border: none;
    background: white;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    border-bottom: 1px solid #eee;
    width: 100%;
    text-align: left;
}

.layer-btn:last-child {
    border-bottom: none;
}

.layer-btn:hover {
    background: #f0f0f0;
}

.layer-btn.active {
    background: var(--color-primary);
    color: white;
}

/* Status Panel */
.status-panel {
    position: absolute;
    bottom: 30px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    box-shadow: var(--shadow-md);
    max-width: 280px;
}

.status-panel h4 {
    margin: 0 0 10px;
    font-size: 0.9rem;
    color: var(--color-dark);
}

.gps-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.8rem;
}

.gps-info span {
    display: flex;
    align-items: center;
    gap: 6px;
}

.gps-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-success);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

/* Legend */
.map-legend {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    padding: 16px;
    background: white;
    border-radius: var(--radius-lg);
    margin-top: 16px;
    box-shadow: var(--shadow-md);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.legend-item:hover {
    background: #e9ecef;
}

.legend-item.active {
    border-color: var(--color-primary);
    background: rgba(0, 136, 206, 0.1);
}

.legend-item.dimmed {
    opacity: 0.4;
}

.legend-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
}

.legend-label {
    font-size: 0.85rem;
    font-weight: 500;
}

.legend-count {
    margin-left: auto;
    background: var(--color-dark);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
}

/* Stats Bar */
.map-stats {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    color: white;
}

.stat-item {
    flex: 1;
    text-align: center;
    padding: 12px;
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-md);
}

.stat-item .value {
    font-size: 1.8rem;
    font-weight: 700;
    display: block;
}

.stat-item .label {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 4px;
}

/* Toolbar */
.map-toolbar {
    display: flex;
    gap: 10px;
    padding: 12px 16px;
    background: white;
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    box-shadow: var(--shadow-md);
    flex-wrap: wrap;
    align-items: center;
}

.toolbar-group {
    display: flex;
    gap: 6px;
    padding-right: 16px;
    border-right: 1px solid #eee;
}

.toolbar-group:last-child {
    border-right: none;
}

.tool-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
}

.tool-btn:hover {
    background: #e9ecef;
    border-color: var(--color-primary);
}

.tool-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.tool-btn.danger:hover {
    background: var(--color-danger);
    color: white;
    border-color: var(--color-danger);
}

/* Search Box */
.search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border: 1px solid #dee2e6;
    border-radius: var(--radius-md);
    font-size: 0.9rem;
}

.search-box input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0,136,206,0.1);
}

.search-box::before {
    content: "üîç";
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.9rem;
}

/* Popup Styling */
.custom-popup .leaflet-popup-content-wrapper {
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
}

.popup-content {
    min-width: 280px;
    padding: 4px;
}

.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.popup-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
}

.popup-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    color: white;
}

.popup-body p {
    margin: 8px 0;
    font-size: 0.85rem;
    display: flex;
    gap: 8px;
}

.popup-body p strong {
    color: #666;
    min-width: 80px;
}

.popup-actions {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
}

.popup-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    text-align: center;
}

.popup-btn-primary {
    background: var(--color-primary);
    color: white;
}

.popup-btn-primary:hover {
    background: #006ba1;
}

.popup-btn-outline {
    background: white;
    border: 1px solid #dee2e6;
    color: var(--color-dark);
}

.popup-btn-outline:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

/* Tooltip Styling */
.report-tooltip {
    background: white !important;
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-md) !important;
    box-shadow: var(--shadow-md) !important;
    padding: 0 !important;
    max-width: 280px;
    z-index: 999 !important;
}

.report-tooltip .leaflet-tooltip-content {
    padding: 0 !important;
    font-size: 12px !important;
    margin: 0 !important;
}

.report-tooltip::before {
    border-top-color: var(--color-primary) !important;
}

/* Cluster Styling */
.marker-cluster-small,
.marker-cluster-medium,
.marker-cluster-large {
    background: rgba(0, 136, 206, 0.6) !important;
}

.marker-cluster-small div,
.marker-cluster-medium div,
.marker-cluster-large div {
    background: var(--color-primary) !important;
    color: white !important;
    font-weight: 700;
}

/* Loading Overlay */
.map-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(26, 26, 46, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    color: white;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Drawing Info */
.drawing-info {
    position: absolute;
    bottom: 30px;
    right: 10px;
    z-index: 1000;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    display: none;
}

.drawing-info.visible {
    display: block;
}

/* Responsive - Mobile First */
@media (max-width: 480px) {
    #map {
        height: 50vh;
        min-height: 300px;
    }
    
    .map-stats {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .stat-item {
        min-width: calc(50% - 4px);
        padding: 10px;
        font-size: 0.9rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .map-toolbar {
        flex-direction: column;
        padding: 8px;
        gap: 8px;
    }
    
    .toolbar-group {
        border-right: none;
        padding-right: 0;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .layer-switcher {
        left: 5px;
        top: 55px;
        max-width: 90vw;
    }
    
    .toolbar-btn {
        min-height: 40px;
        font-size: 14px;
        padding: 8px 12px;
    }
}

@media (min-width: 481px) and (max-width: 768px) {
    #map {
        height: 55vh;
        min-height: 350px;
    }
    
    .map-stats {
        flex-wrap: wrap;
    }
    
    .stat-item {
        min-width: calc(50% - 10px);
    }
    
    .map-toolbar {
        flex-direction: column;
    }
    
    .toolbar-group {
        border-right: none;
        padding-right: 0;
        flex-wrap: wrap;
    }
    
    .layer-switcher {
        left: 10px;
        top: 60px;
    }
}

@media (min-width: 769px) {
    #map {
        height: 100vh;
        min-height: 600px;
    }
    
    .map-toolbar {
        flex-direction: row;
    }
    
    .toolbar-group {
        border-right: 1px solid #ddd;
        padding-right: 15px;
    }
}
</style>
{% endblock %}

{% block breadcrumb %}
    <a href="{% url 'dashboard' %}">Dashboard</a> /
    <span>Map View</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üìç Reports Map View</h1>
    <div class="header-actions">
        <a href="{% url 'reports_list' %}" class="btn btn-outline">
            üìã List View
        </a>
        <a href="{% url 'analytics' %}" class="btn btn-outline">
            üìä Analytics
        </a>
    </div>
</div>

<!-- Stats Bar -->
<div class="map-stats">
    <div class="stat-item">
        <span class="value" id="totalMarkers">{{ reports|length }}</span>
        <span class="label">Total Reports</span>
    </div>
    <div class="stat-item">
        <span class="value" id="visibleMarkers">0</span>
        <span class="label">Visible on Map</span>
    </div>
    <div class="stat-item">
        <span class="value" id="hotspotCount">0</span>
        <span class="label">Hotspot Areas</span>
    </div>
    <div class="stat-item">
        <span class="value" id="drawnZones">0</span>
        <span class="label">Custom Zones</span>
    </div>
</div>

<!-- Toolbar -->
<div class="map-toolbar">
    <div class="toolbar-group">
        <button class="tool-btn active" id="btnMarkers" title="Toggle Markers">
            üìç Markers
        </button>
        <button class="tool-btn" id="btnClusters" title="Toggle Clustering">
            üîò Clusters
        </button>
        <button class="tool-btn" id="btnHeatmap" title="Toggle Heatmap">
            üî• Heatmap
        </button>
    </div>
    
    <div class="toolbar-group">
        <button class="tool-btn" id="btnDraw" title="Draw Zones">
            ‚úèÔ∏è Draw Zone
        </button>
        <button class="tool-btn" id="btnCircle" title="Draw Circle">
            ‚≠ï Circle
        </button>
        <button class="tool-btn danger" id="btnClearDraw" title="Clear Drawings">
            üóëÔ∏è Clear
        </button>
    </div>
    
    <div class="toolbar-group">
        <button class="tool-btn" id="btnLocate" title="Find My Location">
            üì° My Location
        </button>
        <button class="tool-btn" id="btnFitAll" title="Fit All Markers">
            üéØ Fit All
        </button>
    </div>
    
    <div class="search-box">
        <input type="text" id="searchLocation" placeholder="Search location or reference code...">
    </div>
</div>

<!-- Map Container -->
<div class="map-wrapper">
    <div id="map"></div>
    
    <!-- Loading Overlay -->
    <div class="map-loading" id="mapLoading">
        <div class="spinner"></div>
        <p style="margin-top: 16px;">Loading satellite imagery...</p>
    </div>
    
    <!-- Layer Switcher -->
    <div class="layer-switcher" id="layerSwitcher">
        <button class="layer-btn" data-layer="satellite">üõ∞Ô∏è Satellite</button>
        <button class="layer-btn active" data-layer="hybrid">üó∫Ô∏è Hybrid</button>
        <button class="layer-btn" data-layer="streets">üõ£Ô∏è Streets</button>
        <button class="layer-btn" data-layer="terrain">‚õ∞Ô∏è Terrain</button>
        <button class="layer-btn" data-layer="dark">üåô Dark</button>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="control-btn" id="btnZoomIn" title="Zoom In">‚ûï</button>
        <button class="control-btn" id="btnZoomOut" title="Zoom Out">‚ûñ</button>
        <button class="control-btn" id="btnFullscreen" title="Fullscreen">‚õ∂</button>
        <button class="control-btn" id="btnScreenshot" title="Screenshot">üì∏</button>
        <button class="control-btn" id="btnMeasure" title="Measure Distance">üìè</button>
    </div>
    
    <!-- GPS Status Panel -->
    <div class="status-panel" id="gpsPanel" style="display: none;">
        <h4>üì° GPS Tracking Active</h4>
        <div class="gps-info">
            <span><div class="gps-dot"></div> Tracking enabled</span>
            <span>Lat: <strong id="gpsLat">--</strong></span>
            <span>Lng: <strong id="gpsLng">--</strong></span>
            <span>Accuracy: <strong id="gpsAccuracy">--</strong>m</span>
        </div>
    </div>
    
    <!-- Drawing Info -->
    <div class="drawing-info" id="drawingInfo">
        Click on map to draw. Double-click to finish.
    </div>
</div>

<!-- Legend -->
<div class="map-legend" id="mapLegend">
    <div class="legend-item active" data-status="new">
        <div class="legend-dot" style="background: #0088ce;"></div>
        <span class="legend-label">New</span>
        <span class="legend-count" id="countNew">0</span>
    </div>
    <div class="legend-item active" data-status="in_review">
        <div class="legend-dot" style="background: #ffc107;"></div>
        <span class="legend-label">In Review</span>
        <span class="legend-count" id="countInReview">0</span>
    </div>
    <div class="legend-item active" data-status="forwarded">
        <div class="legend-dot" style="background: #17a2b8;"></div>
        <span class="legend-label">Forwarded</span>
        <span class="legend-count" id="countForwarded">0</span>
    </div>
    <div class="legend-item active" data-status="actioned">
        <div class="legend-dot" style="background: #28a745;"></div>
        <span class="legend-label">Actioned</span>
        <span class="legend-count" id="countActioned">0</span>
    </div>
    <div class="legend-item active" data-status="closed">
        <div class="legend-dot" style="background: #6c757d;"></div>
        <span class="legend-label">Closed</span>
        <span class="legend-count" id="countClosed">0</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet Core -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Marker Cluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<!-- Heatmap -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<!-- Draw -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<!-- Fullscreen -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.min.js"></script>

<script>
(function() {
    'use strict';

    // ========== CONFIGURATION ==========
    const CONFIG = {
        center: [-1.9403, 29.8739], // Kigali, Rwanda
        defaultZoom: 13,
        maxZoom: 20,
        minZoom: 5,
        clusterRadius: 50
    };

    const STATUS_COLORS = {
        'new': '#0088ce',
        'in_review': '#ffc107',
        'forwarded': '#17a2b8',
        'actioned': '#28a745',
        'closed': '#6c757d'
    };

    // ========== TILE LAYERS (FREE SATELLITE) ==========
    const TILE_LAYERS = {
        satellite: L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            {
                attribution: '¬© Esri, Maxar, Earthstar Geographics',
                maxZoom: 20
            }
        ),
        hybrid: L.layerGroup([
            L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                { maxZoom: 20 }
            ),
            L.tileLayer(
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { maxZoom: 20, opacity: 0.4 }
            )
        ]),
        streets: L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }
        ),
        terrain: L.tileLayer(
            'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            {
                attribution: '¬© OpenTopoMap',
                maxZoom: 17
            }
        ),
        dark: L.tileLayer(
            'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            {
                attribution: '¬© CartoDB',
                maxZoom: 20
            }
        )
    };

    // ========== STATE ==========
    let map, markersLayer, clusterLayer, heatLayer, drawnItems;
    let userMarker, userCircle, watchId;
    let activeFilters = ['new', 'in_review', 'forwarded', 'actioned', 'closed'];
    let currentLayer = 'hybrid';
    let displayMode = 'markers'; // markers, clusters, heatmap
    let isDrawing = false;
    let isMeasuring = false;
    let measurePoints = [];

    // Reports data from Django - initialize as empty, will fetch via API
    let reports = [];
    
    // Try to get reports from Django template context
    try {
        const templateReports = {{ reports|safe }};
        if (Array.isArray(templateReports)) {
            reports = templateReports;
        }
    } catch (e) {
        console.warn('Could not load reports from template, will fetch from API');
        reports = [];
    }

    let isFirstLoad = true;  // Track if this is the initial load
    
    // ========== INITIALIZATION ==========
    function init() {
        initMap();
        initLayers();
        loadReportsRealTime();
        initControls();
        initDrawing();
        initLegend();
        initSearch();
        updateStats();
        
        // Check if there's a reference code in URL to auto-zoom
        checkURLForReference();
        
        // Hide loading after tiles load
        setTimeout(() => {
            document.getElementById('mapLoading').style.display = 'none';
        }, 1500);

        // Refresh reports every 10 seconds for real-time updates (faster for new submissions)
        setInterval(loadReportsRealTime, 10000);
        
        // Listen for page visibility to optimize updates
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Reduce update frequency when page is hidden
                console.log('Map page hidden - reducing update frequency');
            } else {
                // Resume faster updates when page is visible
                console.log('Map page visible - resuming updates');
            }
        });
    }

    // ========== URL REFERENCE CODE HANDLER ==========
    function checkURLForReference() {
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) {
            // Search for the report with this reference code
            setTimeout(() => {
                const matchingReport = reports.find(r => 
                    r.reference_code && r.reference_code.toLowerCase() === refCode.toLowerCase()
                );
                
                if (matchingReport) {
                    const lat = parseFloat(matchingReport.latitude);
                    const lng = parseFloat(matchingReport.longitude);
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        // Zoom to the report location
                        map.setView([lat, lng], 17);
                        
                        // Find and open the marker popup
                        markersLayer.eachLayer(layer => {
                            if (layer.reportData && layer.reportData.reference_code === matchingReport.reference_code) {
                                layer.openPopup();
                                
                                // Add pulse animation
                                const markerElement = layer.getElement();
                                if (markerElement) {
                                    markerElement.style.animation = 'pulse 2s ease-in-out 5';
                                }
                            }
                        });
                        
                        // Pre-fill search box
                        const searchInput = document.getElementById('searchLocation');
                        if (searchInput) {
                            searchInput.value = refCode;
                        }
                    }
                }
            }, 1000); // Wait for markers to load
        }
    }

    function initMap() {
        // Determine center from first report if available, otherwise use Kigali
        let center = CONFIG.center;
        if (reports.length > 0 && reports[0].latitude && reports[0].longitude) {
            center = [parseFloat(reports[0].latitude), parseFloat(reports[0].longitude)];
        }

        map = L.map('map', {
            center: center,
            zoom: CONFIG.defaultZoom,
            maxZoom: CONFIG.maxZoom,
            minZoom: CONFIG.minZoom,
            zoomControl: false,
            fullscreenControl: true
        });

        // Add default layer
        TILE_LAYERS[currentLayer].addTo(map);

        // Scale control
        L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);
    }

    // ========== REAL-TIME DATA LOADING ==========
    function loadReportsRealTime() {
        // Fetch latest reports from API endpoint
        const apiUrl = '/api/reports/list/';
        
        fetch(apiUrl)
            .then(res => {
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                return res.json();
            })
            .then(data => {
                const newReports = data.results || data || [];
                if (Array.isArray(newReports) && newReports.length > 0) {
                    // Check for new reports submitted
                    const previousCount = reports.length;
                    reports = newReports;
                    
                    // If new reports were added, highlight them
                    if (newReports.length > previousCount) {
                        const newReportsAdded = newReports.slice(previousCount);
                        newReportsAdded.forEach(report => {
                            highlightNewReport(report);
                        });
                    }
                    
                    // Clear and reinitialize markers
                    markersLayer.clearLayers();
                    clusterLayer.clearLayers();
                    initMarkers();
                    updateStats();
                }
            })
            .catch(err => {
                console.error('Error loading reports:', err);
                // Silently fail - use existing data
            });
    }

    // Highlight newly submitted reports with animation
    function highlightNewReport(report) {
        try {
            const lat = parseFloat(report.latitude);
            const lng = parseFloat(report.longitude);
            
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                console.warn('Invalid coordinates for new report:', report.reference_code);
                return;
            }

            // Create animated pulse marker for new reports
            const pulseIcon = L.divIcon({
                className: 'new-report-marker',
                html: `
                    <div style="
                        width: 40px;
                        height: 40px;
                        background: #ffc107;
                        border: 4px solid white;
                        border-radius: 50%;
                        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        animation: reportPulse 2s infinite;
                    ">
                        ‚úì
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });

            // Calculate time ago for newly submitted report
            let timeAgo = '';
            if (report.created_at) {
                try {
                    const date = new Date(report.created_at);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);
                    if (diff < 60) {
                        timeAgo = 'Just now';
                    } else if (diff < 3600) {
                        timeAgo = Math.floor(diff / 60) + ' min ago';
                    }
                } catch (e) {
                    timeAgo = '';
                }
            }

            // Create marker for new report
            const newMarker = L.marker([lat, lng], { icon: pulseIcon })
                .bindPopup(`
                    <div class="popup-content">
                        <div class="popup-header">
                            <h4 class="popup-title" style="color: #ffc107;">üÜï New Report</h4>
                            <span class="popup-badge" style="background: #ffc107; color: #333;">JUST SUBMITTED ${timeAgo ? '(' + timeAgo + ')' : ''}</span>
                        </div>
                        <div class="popup-body">
                            <p><strong>Reference:</strong> ${report.reference_code || 'N/A'}</p>
                            <p><strong>Category:</strong> ${report.category || 'N/A'}</p>
                            <p><strong>Location:</strong> ${report.location_description || 'N/A'}</p>
                            <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                            <p><strong>Status:</strong> <span style="color: #ffc107;">‚è≥ Processing</span></p>
                        </div>
                        <div class="popup-actions">
                            <a href="/dashboard/reports/${report.id}/" class="popup-btn popup-btn-primary">View Details</a>
                        </div>
                    </div>
                `, { className: 'custom-popup', maxWidth: 320 })
                .addTo(map);

            // Automatically zoom to new report
            map.flyTo([lat, lng], 17, { duration: 1.5 });

            // Center on new report
            newMarker.openPopup();

            // Add CSS animation if not already added
            if (!document.getElementById('reportPulseStyle')) {
                const style = document.createElement('style');
                style.id = 'reportPulseStyle';
                style.textContent = `
                    @keyframes reportPulse {
                        0% {
                            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
                            transform: scale(1);
                        }
                        50% {
                            box-shadow: 0 0 0 15px rgba(255, 193, 7, 0);
                            transform: scale(1.05);
                        }
                        100% {
                            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
                            transform: scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            console.log('New report pinned on map:', report.reference_code, lat, lng);
        } catch (e) {
            console.error('Error highlighting new report:', e);
        }
    }

    function initLayers() {
        // Markers layer (default)
        markersLayer = L.layerGroup().addTo(map);
        
        // Cluster layer
        clusterLayer = L.markerClusterGroup({
            maxClusterRadius: CONFIG.clusterRadius,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
        });

        // Heatmap layer (initialized later with data)
        heatLayer = null;

        // Drawing layer
        drawnItems = new L.FeatureGroup().addTo(map);
    }

    // ========== MARKERS ==========
    function initMarkers() {
        const counts = { new: 0, in_review: 0, forwarded: 0, actioned: 0, closed: 0 };
        const heatData = [];

        if (!reports || !Array.isArray(reports)) {
            console.warn('Reports data is invalid or empty');
            return;
        }

        reports.forEach(report => {
            try {
                // Ensure coordinates are valid numbers
                let lat = parseFloat(report.latitude);
                let lng = parseFloat(report.longitude);
                
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                    console.warn('Invalid coordinates for report:', report.reference_code);
                    return;
                }

                // Count by status
                const status = report.status || 'new';
                counts[status] = (counts[status] || 0) + 1;

                // Create custom icon
                const icon = createCustomIcon(status);
                
                // Create marker with correct lat/lng order [latitude, longitude]
                const marker = L.marker([lat, lng], { icon, title: `${report.reference_code}` })
                    .bindPopup(createPopupContent(report), {
                        className: 'custom-popup',
                        maxWidth: 320
                    })
                    .bindTooltip(createTooltipContent(report), {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'report-tooltip'
                    });
                
                marker.reportData = report;
                marker._reportStatus = status;
                markersLayer.addLayer(marker);
                
                // Add to cluster layer
                const clusterMarker = L.marker([lat, lng], { icon })
                    .bindPopup(createPopupContent(report), { className: 'custom-popup' })
                    .bindTooltip(createTooltipContent(report), {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'report-tooltip'
                    });
                clusterLayer.addLayer(clusterMarker);

                // Add to heatmap data [lat, lng, intensity]
                heatData.push([lat, lng, 0.8]);
            } catch (e) {
                console.error('Error processing report:', e, report);
            }
        });

        // Initialize or update heatmap
        if (heatLayer) {
            try {
                map.removeLayer(heatLayer);
            } catch (e) {
                console.warn('Error removing heatmap:', e);
            }
        }
        
        if (heatData.length > 0) {
            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.2: '#0088ce',
                    0.4: '#00a896',
                    0.6: '#ffc107',
                    0.8: '#ff6b35',
                    1.0: '#dc3545'
                }
            });
        }

        // Update counts
        document.getElementById('countNew').textContent = counts.new || 0;
        document.getElementById('countInReview').textContent = counts.in_review || 0;
        document.getElementById('countForwarded').textContent = counts.forwarded || 0;
        document.getElementById('countActioned').textContent = counts.actioned || 0;
        document.getElementById('countClosed').textContent = counts.closed || 0;

        // Fit bounds if markers exist (only on initial load)
        if (isFirstLoad && reports.length > 0) {
            fitAllMarkers();
            isFirstLoad = false;  // Mark that first load is complete
        }
    }

    function createCustomIcon(status) {
        const color = STATUS_COLORS[status] || '#0088ce';
        return L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="
                    width: 30px;
                    height: 30px;
                    background: ${color};
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <div style="
                        width: 10px;
                        height: 10px;
                        background: white;
                        border-radius: 50%;
                    "></div>
                </div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });
    }

    function createTooltipContent(report) {
        const statusEmoji = {
            'new': 'üÜï',
            'in_review': 'üëÅÔ∏è',
            'forwarded': '‚ÜóÔ∏è',
            'actioned': '‚úÖ',
            'closed': 'üîí'
        };
        
        const emoji = statusEmoji[report.status] || 'üìç';
        const statusLabel = (report.status || 'new').replace('_', ' ').toUpperCase();
        
        return `
            <div style="padding: 8px; font-size: 12px; font-weight: 500;">
                <div>${emoji} <strong>${report.reference_code}</strong></div>
                <div style="color: #666; margin-top: 4px;">üìç ${report.location_description || 'Unknown Location'}</div>
                <div style="color: #666;">üìÇ ${report.category || 'N/A'}</div>
                <div style="color: #0088ce; margin-top: 4px;"><strong>${statusLabel}</strong></div>
            </div>
        `;
    }

    function createPopupContent(report) {
        const statusColor = STATUS_COLORS[report.status] || '#0088ce';
        const statusLabel = (report.status || 'new').replace('_', ' ').toUpperCase();
        
        // Parse coordinates as floats
        const lat = parseFloat(report.latitude) || 0;
        const lng = parseFloat(report.longitude) || 0;
        
        // Format date if available and calculate time ago
        let dateStr = 'N/A';
        let timeAgo = '';
        if (report.created_at) {
            try {
                const date = new Date(report.created_at);
                if (!isNaN(date.getTime())) {
                    dateStr = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Calculate time ago
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000); // seconds
                    if (diff < 60) {
                        timeAgo = 'Just now';
                    } else if (diff < 3600) {
                        timeAgo = Math.floor(diff / 60) + ' min ago';
                    } else if (diff < 86400) {
                        timeAgo = Math.floor(diff / 3600) + ' hours ago';
                    } else {
                        timeAgo = Math.floor(diff / 86400) + ' days ago';
                    }
                }
            } catch (e) {
                dateStr = report.created_at;
            }
        }
        
        const description = (report.description || 'N/A').substring(0, 100);
        const hasMore = (report.description || '').length > 100;
        
        // Determine if report is recently submitted (within last 5 minutes)
        const isRecent = timeAgo && (timeAgo.includes('Just now') || 
                         (timeAgo.includes('min') && parseInt(timeAgo) <= 5));
        
        return `
            <div class="popup-content">
                <div class="popup-header">
                    <h4 class="popup-title">${report.reference_code || 'Unknown'}</h4>
                    <span class="popup-badge" style="background: ${statusColor}">${statusLabel}</span>
                </div>
                <div class="popup-body">
                    <p><strong>Category:</strong> ${report.category || 'N/A'}</p>
                    <p><strong>Location:</strong> ${report.location_description || 'N/A'}</p>
                    <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                    <p><strong>Submitted:</strong> ${timeAgo ? timeAgo + ' (' + dateStr + ')' : dateStr}</p>
                    ${isRecent ? '<p style="color: #ffc107; font-weight: bold;">üÜï Recently Submitted</p>' : ''}
                    <p><strong>Description:</strong> ${description}${hasMore ? '...' : ''}</p>
                </div>
                <div class="popup-actions">
                    <a href="/dashboard/reports/${report.id}/" class="popup-btn popup-btn-primary">View Details</a>
                    <button class="popup-btn popup-btn-outline" onclick="window.zoomToReport(${lat}, ${lng})">Zoom Here</button>
                </div>
            </div>
        `;
    }

    // ========== CONTROLS ==========
    function initControls() {
        // Zoom controls
        document.getElementById('btnZoomIn').addEventListener('click', () => map.zoomIn());
        document.getElementById('btnZoomOut').addEventListener('click', () => map.zoomOut());
        
        // Fullscreen
        document.getElementById('btnFullscreen').addEventListener('click', () => {
            if (map.isFullscreen()) {
                map.toggleFullscreen();
            } else {
                map.toggleFullscreen();
            }
        });

        // Layer switcher
        document.querySelectorAll('.layer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const layer = this.dataset.layer;
                switchLayer(layer);
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Display mode buttons
        document.getElementById('btnMarkers').addEventListener('click', () => setDisplayMode('markers'));
        document.getElementById('btnClusters').addEventListener('click', () => setDisplayMode('clusters'));
        document.getElementById('btnHeatmap').addEventListener('click', () => setDisplayMode('heatmap'));

        // Geolocation
        document.getElementById('btnLocate').addEventListener('click', startGeolocation);
        
        // Fit all markers
        document.getElementById('btnFitAll').addEventListener('click', fitAllMarkers);

        // Screenshot
        document.getElementById('btnScreenshot').addEventListener('click', takeScreenshot);

        // Measure tool
        document.getElementById('btnMeasure').addEventListener('click', toggleMeasure);
    }

    function switchLayer(layerName) {
        try {
            // Remove current layer
            Object.entries(TILE_LAYERS).forEach(([name, layer]) => {
                try {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                } catch (e) {
                    console.warn(`Error removing layer ${name}:`, e);
                }
            });
            
            // Add new layer
            if (TILE_LAYERS[layerName]) {
                TILE_LAYERS[layerName].addTo(map);
                currentLayer = layerName;
            }
        } catch (e) {
            console.error('Error switching layer:', e);
        }
    }

    function setDisplayMode(mode) {
        try {
            // Update button states
            document.getElementById('btnMarkers').classList.toggle('active', mode === 'markers');
            document.getElementById('btnClusters').classList.toggle('active', mode === 'clusters');
            document.getElementById('btnHeatmap').classList.toggle('active', mode === 'heatmap');

            // Remove all display layers
            [markersLayer, clusterLayer].forEach(layer => {
                try {
                    if (layer && map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                } catch (e) {}
            });
            
            if (heatLayer) {
                try {
                    if (map.hasLayer(heatLayer)) {
                        map.removeLayer(heatLayer);
                    }
                } catch (e) {}
            }

            // Add selected layer
            switch(mode) {
                case 'markers':
                    if (markersLayer) map.addLayer(markersLayer);
                    break;
                case 'clusters':
                    if (clusterLayer) map.addLayer(clusterLayer);
                    break;
                case 'heatmap':
                    if (heatLayer) map.addLayer(heatLayer);
                    break;
            }

            displayMode = mode;
            updateStats();
        } catch (e) {
            console.error('Error setting display mode:', e);
        }
    }

    // ========== GEOLOCATION ==========
    function startGeolocation() {
        const btn = document.getElementById('btnLocate');
        const panel = document.getElementById('gpsPanel');
        
        if (watchId) {
            // Stop tracking
            try {
                navigator.geolocation.clearWatch(watchId);
            } catch (e) {
                console.warn('Error clearing geolocation watch:', e);
            }
            watchId = null;
            btn.classList.remove('active');
            panel.style.display = 'none';
            if (userMarker) {
                try { map.removeLayer(userMarker); } catch (e) {}
            }
            if (userCircle) {
                try { map.removeLayer(userCircle); } catch (e) {}
            }
            return;
        }

        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        btn.classList.add('active');
        panel.style.display = 'block';

        watchId = navigator.geolocation.watchPosition(
            position => {
                try {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    // Update GPS panel
                    document.getElementById('gpsLat').textContent = latitude.toFixed(6);
                    document.getElementById('gpsLng').textContent = longitude.toFixed(6);
                    document.getElementById('gpsAccuracy').textContent = accuracy.toFixed(1);

                    // Update or create user marker
                    if (userMarker) {
                        userMarker.setLatLng([latitude, longitude]);
                        userCircle.setLatLng([latitude, longitude]);
                        userCircle.setRadius(accuracy);
                    } else {
                        // Create pulsing user marker
                        userMarker = L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: `
                                    <div style="
                                        width: 20px;
                                        height: 20px;
                                        background: #4285f4;
                                        border: 3px solid white;
                                        border-radius: 50%;
                                        box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4);
                                        animation: userPulse 2s infinite;
                                    "></div>
                                `,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);

                        // Accuracy circle
                        userCircle = L.circle([latitude, longitude], {
                            radius: accuracy,
                            color: '#4285f4',
                            fillColor: '#4285f4',
                            fillOpacity: 0.15,
                            weight: 2
                        }).addTo(map);

                        // Add CSS for pulse animation
                        if (!document.getElementById('userPulseStyle')) {
                            const style = document.createElement('style');
                            style.id = 'userPulseStyle';
                            style.textContent = `
                                @keyframes userPulse {
                                    0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4); }
                                    70% { box-shadow: 0 0 0 15px rgba(66, 133, 244, 0); }
                                    100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); }
                                }
                            `;
                            document.head.appendChild(style);
                        }

                        map.setView([latitude, longitude], 17);
                    }
                } catch (e) {
                    console.error('Error processing geolocation:', e);
                }
            },
            error => {
                console.error('Geolocation error:', error);
                btn.classList.remove('active');
                panel.style.display = 'none';
                
                // Display user-friendly error messages
                let msg = 'Unable to get your location';
                if (error.code === 1) msg = 'Location permission denied';
                else if (error.code === 2) msg = 'Position unavailable';
                else if (error.code === 3) msg = 'Location request timed out';
                
                alert(msg);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // ========== DRAWING TOOLS ==========
    function initDrawing() {
        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polyline: false,
                marker: false,
                circlemarker: false,
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#e63946',
                        fillColor: '#e63946',
                        fillOpacity: 0.2,
                        weight: 3
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#ff9e00',
                        fillColor: '#ff9e00',
                        fillOpacity: 0.2,
                        weight: 3
                    }
                },
                circle: {
                    shapeOptions: {
                        color: '#6a4c93',
                        fillColor: '#6a4c93',
                        fillOpacity: 0.2,
                        weight: 3
                    }
                }
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });

        // Custom draw buttons
        document.getElementById('btnDraw').addEventListener('click', function() {
            new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
            document.getElementById('drawingInfo').classList.add('visible');
            this.classList.add('active');
        });

        document.getElementById('btnCircle').addEventListener('click', function() {
            new L.Draw.Circle(map, drawControl.options.draw.circle).enable();
            document.getElementById('drawingInfo').classList.add('visible');
            this.classList.add('active');
        });

        document.getElementById('btnClearDraw').addEventListener('click', () => {
            drawnItems.clearLayers();
            updateStats();
        });

        // Handle draw events
        map.on(L.Draw.Event.CREATED, function(e) {
            const layer = e.layer;
            
            // Count reports in drawn area
            let reportsInArea = 0;
            markersLayer.eachLayer(marker => {
                if (marker.reportData) {
                    const latlng = marker.getLatLng();
                    const isInArea = layer.getBounds ? 
                        layer.getBounds().contains(latlng) : 
                        (latlng.distanceTo(layer.getLatLng()) <= layer.getRadius());
                    
                    if (isInArea) {
                        reportsInArea++;
                    }
                }
            });

            // Add popup with info
            layer.bindPopup(`
                <div style="text-align: center; padding: 8px;">
                    <strong>Custom Zone</strong><br>
                    <span style="color: #666;">Reports in area: <strong>${reportsInArea}</strong></span>
                </div>
            `);

            drawnItems.addLayer(layer);
            document.getElementById('drawingInfo').classList.remove('visible');
            document.getElementById('btnDraw').classList.remove('active');
            document.getElementById('btnCircle').classList.remove('active');
            updateStats();
        });

        map.on('draw:drawstop', function() {
            document.getElementById('drawingInfo').classList.remove('visible');
            document.getElementById('btnDraw').classList.remove('active');
            document.getElementById('btnCircle').classList.remove('active');
        });
    }

    // ========== LEGEND FILTERING ==========
    function initLegend() {
        document.querySelectorAll('.legend-item').forEach(item => {
            item.addEventListener('click', function() {
                const status = this.dataset.status;
                this.classList.toggle('active');
                this.classList.toggle('dimmed', !this.classList.contains('active'));

                if (this.classList.contains('active')) {
                    activeFilters.push(status);
                } else {
                    activeFilters = activeFilters.filter(f => f !== status);
                }

                filterMarkers();
            });
        });
    }

    function filterMarkers() {
        markersLayer.eachLayer(marker => {
            if (marker.reportData) {
                const show = activeFilters.includes(marker.reportData.status);
                marker.setOpacity(show ? 1 : 0);
                if (!show) marker.closePopup();
            }
        });
        updateStats();
    }

    // ========== SEARCH ==========
    function initSearch() {
        const searchInput = document.getElementById('searchLocation');
        let searchTimeout;
        let searchMarker = null;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) {
                if (searchMarker) {
                    try { map.removeLayer(searchMarker); } catch (e) {}
                    searchMarker = null;
                }
                return;
            }

            searchTimeout = setTimeout(() => {
                // First, try to find a matching reference code in reports
                const matchingReport = reports.find(r => 
                    r.reference_code && r.reference_code.toLowerCase().includes(query.toLowerCase())
                );

                if (matchingReport) {
                    // Found a report by reference code
                    const lat = parseFloat(matchingReport.latitude);
                    const lng = parseFloat(matchingReport.longitude);
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        // Remove old search marker
                        if (searchMarker) {
                            try { map.removeLayer(searchMarker); } catch (e) {}
                        }
                        
                        // Zoom to the report location
                        map.setView([lat, lng], 17);
                        
                        // Find and highlight the actual marker
                        markersLayer.eachLayer(layer => {
                            if (layer.reportData && layer.reportData.reference_code === matchingReport.reference_code) {
                                // Pulse animation
                                layer.openPopup();
                                const markerElement = layer.getElement();
                                if (markerElement) {
                                    markerElement.style.animation = 'pulse 2s ease-in-out 3';
                                }
                            }
                        });
                        
                        return;
                    }
                }

                // If no reference code match, search using Nominatim (free geocoding)
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Search error: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        if (data && data.length > 0) {
                            const { lat, lon, display_name } = data[0];
                            
                            // Remove old search marker
                            if (searchMarker) {
                                try { map.removeLayer(searchMarker); } catch (e) {}
                            }
                            
                            // Add new search marker
                            searchMarker = L.marker([parseFloat(lat), parseFloat(lon)], {
                                icon: L.divIcon({
                                    className: 'search-marker',
                                    html: '<div style="width:40px;height:40px;background:#e63946;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:white;">üìç</div>',
                                    iconSize: [40, 40],
                                    iconAnchor: [20, 20]
                                })
                            }).addTo(map)
                            .bindPopup(`<strong>Search Result</strong><br>${display_name}`).openPopup();

                            map.setView([parseFloat(lat), parseFloat(lon)], 16);

                            // Remove marker after 10 seconds
                            setTimeout(() => {
                                if (searchMarker) {
                                    try { map.removeLayer(searchMarker); } catch (e) {}
                                    searchMarker = null;
                                }
                            }, 10000);
                        }
                    })
                    .catch(err => {
                        console.error('Search error:', err);
                        // Silently fail - user can try again
                    });
            }, 500);
        });
    }

    // ========== UTILITIES ==========
    function fitAllMarkers() {
        try {
            const validReports = reports.filter(r => {
                const lat = parseFloat(r.latitude);
                const lng = parseFloat(r.longitude);
                return lat && lng && !isNaN(lat) && !isNaN(lng);
            });
            
            if (validReports.length === 0) {
                map.setView(CONFIG.center, CONFIG.defaultZoom);
                return;
            }

            if (validReports.length === 1) {
                map.setView([parseFloat(validReports[0].latitude), parseFloat(validReports[0].longitude)], 16);
            } else {
                const bounds = L.latLngBounds(validReports.map(r => [parseFloat(r.latitude), parseFloat(r.longitude)]));
                map.fitBounds(bounds.pad(0.1));
            }
        } catch (e) {
            console.error('Error fitting bounds:', e);
            map.setView(CONFIG.center, CONFIG.defaultZoom);
        }
    }

    function updateStats() {
        try {
            let visible = 0;
            markersLayer.eachLayer(marker => {
                if (marker.reportData && marker.options.opacity !== 0) visible++;
            });
            
            const visibleElement = document.getElementById('visibleMarkers');
            const drawnElement = document.getElementById('drawnZones');
            const hotspotElement = document.getElementById('hotspotCount');
            
            if (visibleElement) visibleElement.textContent = visible;
            if (drawnElement) drawnElement.textContent = drawnItems ? drawnItems.getLayers().length : 0;
            if (hotspotElement) hotspotElement.textContent = Math.max(0, Math.floor((reports.length || 0) / 5));
        } catch (e) {
            console.warn('Error updating stats:', e);
        }
    }

    function takeScreenshot() {
        alert('Screenshot feature requires html2canvas library. The map will be captured and downloaded.');
        // Implementation would use html2canvas library
    }

    function toggleMeasure() {
        const btn = document.getElementById('btnMeasure');
        isMeasuring = !isMeasuring;
        btn.classList.toggle('active', isMeasuring);
        
        if (isMeasuring) {
            map.getContainer().style.cursor = 'crosshair';
            measurePoints = [];
        } else {
            map.getContainer().style.cursor = '';
        }
    }

    // Global function for popup - must be accessible from popup content
    window.zoomToReport = function(lat, lng) {
        try {
            map.setView([lat, lng], 18);
        } catch (e) {
            console.error('Error zooming to report:', e);
        }
    };

    // ========== INITIALIZE ==========
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}